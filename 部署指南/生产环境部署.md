# n8n 生产环境部署指南

## 部署概述

### 部署架构
```
Internet → Load Balancer → n8n Cluster → Database
              ↓
         SSL Termination
              ↓
         Reverse Proxy (Nginx)
              ↓
         n8n Instances
              ↓
         PostgreSQL Database
```

### 系统要求
- **CPU**: 4核心以上
- **内存**: 8GB以上
- **存储**: 100GB以上SSD
- **网络**: 稳定的网络连接
- **操作系统**: Ubuntu 20.04+ / CentOS 8+ / RHEL 8+

## 详细部署步骤

### 1. 环境准备

#### 1.1 系统更新
```bash
# Ubuntu/Debian
sudo apt update && sudo apt upgrade -y

# CentOS/RHEL
sudo yum update -y
```

#### 1.2 安装Docker和Docker Compose
```bash
# 安装Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
sudo usermod -aG docker $USER

# 安装Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# 启动Docker服务
sudo systemctl start docker
sudo systemctl enable docker
```

#### 1.3 安装Nginx
```bash
# Ubuntu/Debian
sudo apt install nginx -y

# CentOS/RHEL
sudo yum install nginx -y

# 启动Nginx
sudo systemctl start nginx
sudo systemctl enable nginx
```

### 2. 数据库配置

#### 2.1 PostgreSQL配置
```bash
# 创建数据库目录
sudo mkdir -p /opt/n8n/postgres
sudo chown 999:999 /opt/n8n/postgres

# 创建数据库初始化脚本
sudo tee /opt/n8n/postgres/init.sql << EOF
CREATE DATABASE n8n;
CREATE USER n8n WITH PASSWORD 'secure_n8n_password';
GRANT ALL PRIVILEGES ON DATABASE n8n TO n8n;
ALTER USER n8n CREATEDB;
EOF
```

#### 2.2 Redis配置（可选，用于缓存）
```bash
# 创建Redis目录
sudo mkdir -p /opt/n8n/redis
sudo chown 999:999 /opt/n8n/redis
```

### 3. n8n应用配置

#### 3.1 创建应用目录
```bash
# 创建n8n应用目录
sudo mkdir -p /opt/n8n/app
sudo mkdir -p /opt/n8n/logs
sudo mkdir -p /opt/n8n/backups

# 设置权限
sudo chown -R $USER:$USER /opt/n8n
```

#### 3.2 环境变量配置
```bash
# 创建环境变量文件
sudo tee /opt/n8n/app/.env << EOF
# n8n基础配置
N8N_BASIC_AUTH_ACTIVE=true
N8N_BASIC_AUTH_USER=admin
N8N_BASIC_AUTH_PASSWORD=your_secure_password_here

# 数据库配置
DB_TYPE=postgresdb
DB_POSTGRESDB_HOST=postgres
DB_POSTGRESDB_PORT=5432
DB_POSTGRESDB_DATABASE=n8n
DB_POSTGRESDB_USER=n8n
DB_POSTGRESDB_PASSWORD=secure_n8n_password

# Redis配置（可选）
REDIS_HOST=redis
REDIS_PORT=6379

# 安全配置
N8N_ENCRYPTION_KEY=your_32_character_encryption_key_here
N8N_JWT_SECRET=your_jwt_secret_here

# 邮件配置
N8N_EMAIL_MODE=smtp
N8N_SMTP_HOST=smtp.gmail.com
N8N_SMTP_PORT=587
N8N_SMTP_USER=your_email@gmail.com
N8N_SMTP_PASS=your_email_password
N8N_SMTP_SENDER=your_email@gmail.com

# 日志配置
N8N_LOG_LEVEL=info
N8N_LOG_OUTPUT=file
N8N_LOG_FILE=/home/node/.n8n/logs/n8n.log

# 性能配置
N8N_EXECUTIONS_PROCESS=main
N8N_EXECUTIONS_MODE=regular
N8N_QUEUE_BULL_REDIS_HOST=redis
N8N_QUEUE_BULL_REDIS_PORT=6379

# 外部访问配置
N8N_HOST=your_domain.com
N8N_PORT=5678
N8N_PROTOCOL=https
N8N_WEBHOOK_URL=https://your_domain.com

# 备份配置
N8N_BACKUP_ENABLED=true
N8N_BACKUP_TIME=02:00
N8N_BACKUP_RETENTION_DAYS=30
EOF
```

#### 3.3 Docker Compose配置
```yaml
# /opt/n8n/app/docker-compose.yml
version: '3.8'

services:
  n8n:
    image: n8nio/n8n:latest
    container_name: n8n
    restart: unless-stopped
    ports:
      - "127.0.0.1:5678:5678"
    environment:
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=${N8N_BASIC_AUTH_USER}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_BASIC_AUTH_PASSWORD}
      - DB_TYPE=${DB_TYPE}
      - DB_POSTGRESDB_HOST=${DB_POSTGRESDB_HOST}
      - DB_POSTGRESDB_PORT=${DB_POSTGRESDB_PORT}
      - DB_POSTGRESDB_DATABASE=${DB_POSTGRESDB_DATABASE}
      - DB_POSTGRESDB_USER=${DB_POSTGRESDB_USER}
      - DB_POSTGRESDB_PASSWORD=${DB_POSTGRESDB_PASSWORD}
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}
      - N8N_JWT_SECRET=${N8N_JWT_SECRET}
      - N8N_HOST=${N8N_HOST}
      - N8N_PORT=${N8N_PORT}
      - N8N_PROTOCOL=${N8N_PROTOCOL}
      - N8N_WEBHOOK_URL=${N8N_WEBHOOK_URL}
      - N8N_LOG_LEVEL=${N8N_LOG_LEVEL}
      - N8N_LOG_OUTPUT=${N8N_LOG_OUTPUT}
      - N8N_LOG_FILE=${N8N_LOG_FILE}
      - N8N_EXECUTIONS_PROCESS=${N8N_EXECUTIONS_PROCESS}
      - N8N_EXECUTIONS_MODE=${N8N_EXECUTIONS_MODE}
      - N8N_QUEUE_BULL_REDIS_HOST=${N8N_QUEUE_BULL_REDIS_HOST}
      - N8N_QUEUE_BULL_REDIS_PORT=${N8N_QUEUE_BULL_REDIS_PORT}
    volumes:
      - n8n_data:/home/node/.n8n
      - /opt/n8n/logs:/home/node/.n8n/logs
      - /opt/n8n/backups:/home/node/.n8n/backups
    depends_on:
      - postgres
      - redis
    networks:
      - n8n_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5678/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3

  postgres:
    image: postgres:13
    container_name: n8n_postgres
    restart: unless-stopped
    environment:
      - POSTGRES_DB=${DB_POSTGRESDB_DATABASE}
      - POSTGRES_USER=${DB_POSTGRESDB_USER}
      - POSTGRES_PASSWORD=${DB_POSTGRESDB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - /opt/n8n/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - n8n_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_POSTGRESDB_USER} -d ${DB_POSTGRESDB_DATABASE}"]
      interval: 30s
      timeout: 10s
      retries: 3

  redis:
    image: redis:7-alpine
    container_name: n8n_redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    networks:
      - n8n_network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  nginx:
    image: nginx:alpine
    container_name: n8n_nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - n8n
    networks:
      - n8n_network

volumes:
  n8n_data:
  postgres_data:
  redis_data:

networks:
  n8n_network:
    driver: bridge
```

### 4. Nginx反向代理配置

#### 4.1 Nginx配置文件
```nginx
# /opt/n8n/app/nginx.conf
events {
    worker_connections 1024;
}

http {
    upstream n8n_backend {
        server n8n:5678;
    }

    # 限制请求大小
    client_max_body_size 10M;

    # Gzip压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        application/atom+xml
        image/svg+xml;

    # 安全头
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;

    server {
        listen 80;
        server_name your_domain.com;
        
        # 重定向到HTTPS
        return 301 https://$server_name$request_uri;
    }

    server {
        listen 443 ssl http2;
        server_name your_domain.com;

        # SSL配置
        ssl_certificate /etc/nginx/ssl/cert.pem;
        ssl_certificate_key /etc/nginx/ssl/key.pem;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
        ssl_prefer_server_ciphers off;
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;

        # 安全头
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

        # 代理配置
        location / {
            proxy_pass http://n8n_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # WebSocket支持
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            
            # 超时设置
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # 健康检查
        location /healthz {
            proxy_pass http://n8n_backend/healthz;
            access_log off;
        }

        # 静态文件缓存
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
            proxy_pass http://n8n_backend;
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
}
```

### 5. SSL证书配置

#### 5.1 使用Let's Encrypt（推荐）
```bash
# 安装Certbot
sudo apt install certbot python3-certbot-nginx -y

# 获取SSL证书
sudo certbot --nginx -d your_domain.com

# 自动续期
sudo crontab -e
# 添加以下行
0 12 * * * /usr/bin/certbot renew --quiet
```

#### 5.2 手动SSL证书
```bash
# 创建SSL目录
sudo mkdir -p /opt/n8n/app/ssl

# 将证书文件复制到目录
sudo cp your_cert.pem /opt/n8n/app/ssl/cert.pem
sudo cp your_key.pem /opt/n8n/app/ssl/key.pem

# 设置权限
sudo chmod 600 /opt/n8n/app/ssl/*
```

### 6. 启动服务

#### 6.1 启动n8n服务
```bash
cd /opt/n8n/app

# 启动服务
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f n8n
```

#### 6.2 验证部署
```bash
# 检查服务状态
curl -I http://localhost:5678

# 检查数据库连接
docker-compose exec postgres psql -U n8n -d n8n -c "\dt"

# 检查Redis连接
docker-compose exec redis redis-cli ping
```

### 7. 监控和日志

#### 7.1 日志配置
```bash
# 创建日志轮转配置
sudo tee /etc/logrotate.d/n8n << EOF
/opt/n8n/logs/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 644 n8n n8n
    postrotate
        docker-compose -f /opt/n8n/app/docker-compose.yml restart n8n
    endscript
}
EOF
```

#### 7.2 监控脚本
```bash
# 创建监控脚本
sudo tee /opt/n8n/scripts/monitor.sh << 'EOF'
#!/bin/bash

# 检查n8n服务状态
check_n8n() {
    if ! curl -f http://localhost:5678/healthz > /dev/null 2>&1; then
        echo "$(date): n8n服务异常，尝试重启..." >> /opt/n8n/logs/monitor.log
        cd /opt/n8n/app && docker-compose restart n8n
    fi
}

# 检查数据库连接
check_database() {
    if ! docker-compose -f /opt/n8n/app/docker-compose.yml exec -T postgres pg_isready -U n8n > /dev/null 2>&1; then
        echo "$(date): 数据库连接异常" >> /opt/n8n/logs/monitor.log
    fi
}

# 检查磁盘空间
check_disk() {
    usage=$(df /opt/n8n | tail -1 | awk '{print $5}' | sed 's/%//')
    if [ $usage -gt 80 ]; then
        echo "$(date): 磁盘使用率过高: ${usage}%" >> /opt/n8n/logs/monitor.log
    fi
}

# 执行检查
check_n8n
check_database
check_disk
EOF

# 设置执行权限
sudo chmod +x /opt/n8n/scripts/monitor.sh

# 添加到crontab
sudo crontab -e
# 添加以下行（每5分钟检查一次）
*/5 * * * * /opt/n8n/scripts/monitor.sh
```

### 8. 备份策略

#### 8.1 数据库备份
```bash
# 创建备份脚本
sudo tee /opt/n8n/scripts/backup.sh << 'EOF'
#!/bin/bash

BACKUP_DIR="/opt/n8n/backups"
DATE=$(date +%Y%m%d_%H%M%S)

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份数据库
docker-compose -f /opt/n8n/app/docker-compose.yml exec -T postgres pg_dump -U n8n n8n > $BACKUP_DIR/n8n_db_$DATE.sql

# 备份n8n数据
docker-compose -f /opt/n8n/app/docker-compose.yml exec n8n tar -czf - /home/node/.n8n > $BACKUP_DIR/n8n_data_$DATE.tar.gz

# 压缩数据库备份
gzip $BACKUP_DIR/n8n_db_$DATE.sql

# 删除30天前的备份
find $BACKUP_DIR -name "*.sql.gz" -mtime +30 -delete
find $BACKUP_DIR -name "*.tar.gz" -mtime +30 -delete

echo "备份完成: $DATE" >> /opt/n8n/logs/backup.log
EOF

# 设置执行权限
sudo chmod +x /opt/n8n/scripts/backup.sh

# 添加到crontab（每天凌晨2点备份）
sudo crontab -e
# 添加以下行
0 2 * * * /opt/n8n/scripts/backup.sh
```

#### 8.2 恢复脚本
```bash
# 创建恢复脚本
sudo tee /opt/n8n/scripts/restore.sh << 'EOF'
#!/bin/bash

if [ $# -eq 0 ]; then
    echo "用法: $0 <备份日期>"
    echo "示例: $0 20240115_020000"
    exit 1
fi

BACKUP_DATE=$1
BACKUP_DIR="/opt/n8n/backups"

# 停止n8n服务
cd /opt/n8n/app
docker-compose stop n8n

# 恢复数据库
gunzip -c $BACKUP_DIR/n8n_db_$BACKUP_DATE.sql.gz | docker-compose exec -T postgres psql -U n8n -d n8n

# 恢复n8n数据
docker-compose exec n8n rm -rf /home/node/.n8n/*
docker-compose exec n8n tar -xzf - < $BACKUP_DIR/n8n_data_$BACKUP_DATE.tar.gz

# 启动n8n服务
docker-compose start n8n

echo "恢复完成: $BACKUP_DATE"
EOF

sudo chmod +x /opt/n8n/scripts/restore.sh
```

### 9. 安全配置

#### 9.1 防火墙配置
```bash
# 配置UFW防火墙
sudo ufw allow ssh
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw deny 5678/tcp  # 阻止直接访问n8n端口
sudo ufw enable
```

#### 9.2 安全加固
```bash
# 禁用root登录
sudo passwd -l root

# 配置SSH密钥认证
sudo mkdir -p ~/.ssh
sudo tee ~/.ssh/authorized_keys << EOF
your_public_key_here
EOF

# 禁用密码认证
sudo tee /etc/ssh/sshd_config.d/disable_password_auth.conf << EOF
PasswordAuthentication no
PermitRootLogin no
EOF

sudo systemctl restart ssh
```

### 10. 性能优化

#### 10.1 系统优化
```bash
# 优化内核参数
sudo tee /etc/sysctl.d/99-n8n.conf << EOF
net.core.somaxconn = 65535
net.ipv4.tcp_max_syn_backlog = 65535
net.core.netdev_max_backlog = 65535
vm.max_map_count = 262144
EOF

sudo sysctl -p /etc/sysctl.d/99-n8n.conf
```

#### 10.2 Docker优化
```bash
# 优化Docker配置
sudo tee /etc/docker/daemon.json << EOF
{
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "10m",
    "max-file": "3"
  },
  "storage-driver": "overlay2",
  "storage-opts": [
    "overlay2.override_kernel_check=true"
  ]
}
EOF

sudo systemctl restart docker
```

## 部署验证清单

### 基础功能验证
- [ ] n8n服务正常启动
- [ ] 数据库连接正常
- [ ] Redis连接正常
- [ ] Web界面可访问
- [ ] SSL证书配置正确
- [ ] 反向代理工作正常

### 安全验证
- [ ] 防火墙配置正确
- [ ] 直接端口访问被阻止
- [ ] SSL证书有效
- [ ] 安全头配置正确
- [ ] 备份功能正常

### 性能验证
- [ ] 服务响应时间正常
- [ ] 内存使用合理
- [ ] 磁盘空间充足
- [ ] 日志轮转正常
- [ ] 监控脚本运行正常

## 故障排除

### 常见问题

#### 1. 服务无法启动
```bash
# 检查日志
docker-compose logs n8n

# 检查端口占用
sudo netstat -tlnp | grep 5678

# 检查环境变量
docker-compose config
```

#### 2. 数据库连接失败
```bash
# 检查数据库状态
docker-compose ps postgres

# 检查数据库日志
docker-compose logs postgres

# 测试数据库连接
docker-compose exec postgres psql -U n8n -d n8n -c "SELECT 1;"
```

#### 3. SSL证书问题
```bash
# 检查证书有效性
openssl x509 -in /opt/n8n/app/ssl/cert.pem -text -noout

# 检查Nginx配置
docker-compose exec nginx nginx -t

# 重新生成证书
sudo certbot renew --force-renewal
```

### 联系支持
如果遇到无法解决的问题，请：
1. 收集完整的错误日志
2. 记录系统环境信息
3. 提供复现步骤
4. 联系技术支持团队 