# 电商订单自动化项目案例

## 项目概述

### 业务背景
某电商平台每天处理大量订单，需要自动化处理订单流程，包括订单验证、库存检查、发货通知等环节，以提高效率并减少人工错误。

### 项目目标
- 自动化订单处理流程
- 减少人工干预
- 提高处理效率
- 降低错误率
- 改善客户体验

### 技术架构
```
订单接收 → 数据验证 → 库存检查 → 支付确认 → 发货处理 → 通知发送
    ↓         ↓         ↓         ↓         ↓         ↓
  Webhook   验证逻辑   库存API   支付API   物流API   邮件/SMS
```

## 详细实现

### 1. 订单接收模块

#### 1.1 Webhook触发器配置
```javascript
// Webhook节点配置
{
  "httpMethod": "POST",
  "path": "order-webhook",
  "responseMode": "responseNode",
  "options": {
    "rawBody": true
  }
}
```

#### 1.2 订单数据验证
```javascript
// Code节点：订单验证逻辑
const order = $input.first().json;
const validation = {
  isValid: true,
  errors: [],
  warnings: []
};

// 基础字段验证
if (!order.orderId || order.orderId.trim() === '') {
  validation.isValid = false;
  validation.errors.push('订单ID不能为空');
}

if (!order.customerEmail || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(order.customerEmail)) {
  validation.isValid = false;
  validation.errors.push('客户邮箱格式不正确');
}

if (!order.items || !Array.isArray(order.items) || order.items.length === 0) {
  validation.isValid = false;
  validation.errors.push('订单商品不能为空');
}

// 商品信息验证
order.items.forEach((item, index) => {
  if (!item.productId || !item.quantity || item.quantity <= 0) {
    validation.isValid = false;
    validation.errors.push(`商品${index + 1}信息不完整`);
  }
});

// 金额验证
if (!order.totalAmount || order.totalAmount <= 0) {
  validation.isValid = false;
  validation.errors.push('订单金额必须大于0');
}

return [{
  json: {
    order,
    validation,
    receivedAt: new Date().toISOString()
  }
}];
```

### 2. 库存检查模块

#### 2.1 库存查询API调用
```javascript
// Code节点：构建库存查询请求
const order = $input.first().json.order;
const items = order.items;

// 构建库存查询请求
const stockRequests = items.map(item => ({
  productId: item.productId,
  quantity: item.quantity
}));

return [{
  json: {
    method: 'POST',
    url: 'https://api.inventory.com/check-stock',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer {{ $env.INVENTORY_API_KEY }}'
    },
    body: JSON.stringify({
      items: stockRequests
    })
  }
}];
```

#### 2.2 库存检查结果处理
```javascript
// Code节点：处理库存检查结果
const order = $input.first().json.order;
const stockResponse = $input.first().json;

const stockCheck = {
  isAvailable: true,
  unavailableItems: [],
  warnings: []
};

stockResponse.items.forEach(item => {
  if (!item.isAvailable) {
    stockCheck.isAvailable = false;
    stockCheck.unavailableItems.push({
      productId: item.productId,
      requestedQuantity: item.requestedQuantity,
      availableQuantity: item.availableQuantity
    });
  } else if (item.availableQuantity < item.requestedQuantity * 1.2) {
    // 库存不足20%时发出警告
    stockCheck.warnings.push({
      productId: item.productId,
      availableQuantity: item.availableQuantity,
      message: '库存偏低，建议及时补货'
    });
  }
});

return [{
  json: {
    order,
    stockCheck,
    checkedAt: new Date().toISOString()
  }
}];
```

### 3. 支付确认模块

#### 3.1 支付状态查询
```javascript
// Code节点：查询支付状态
const order = $input.first().json.order;
const paymentId = order.paymentId;

return [{
  json: {
    method: 'GET',
    url: `https://api.payment.com/payments/${paymentId}`,
    headers: {
      'Authorization': 'Bearer {{ $env.PAYMENT_API_KEY }}'
    }
  }
}];
```

#### 3.2 支付验证逻辑
```javascript
// Code节点：支付验证
const order = $input.first().json.order;
const paymentInfo = $input.first().json;

const paymentValidation = {
  isPaid: false,
  isVerified: false,
  errors: []
};

// 检查支付状态
if (paymentInfo.status === 'paid') {
  paymentValidation.isPaid = true;
  
  // 验证支付金额
  if (Math.abs(paymentInfo.amount - order.totalAmount) < 0.01) {
    paymentValidation.isVerified = true;
  } else {
    paymentValidation.errors.push('支付金额与订单金额不匹配');
  }
  
  // 验证支付时间
  const paymentTime = new Date(paymentInfo.paidAt);
  const orderTime = new Date(order.createdAt);
  const timeDiff = Math.abs(paymentTime - orderTime) / (1000 * 60 * 60); // 小时差
  
  if (timeDiff > 24) {
    paymentValidation.errors.push('支付时间与订单时间相差过大');
  }
} else {
  paymentValidation.errors.push(`支付状态异常: ${paymentInfo.status}`);
}

return [{
  json: {
    order,
    paymentValidation,
    paymentInfo,
    validatedAt: new Date().toISOString()
  }
}];
```

### 4. 发货处理模块

#### 4.1 生成发货单
```javascript
// Code节点：生成发货单
const order = $input.first().json.order;
const stockCheck = $input.first().json.stockCheck;
const paymentValidation = $input.first().json.paymentValidation;

// 检查是否可以发货
if (!stockCheck.isAvailable || !paymentValidation.isVerified) {
  return [{
    json: {
      canShip: false,
      reason: !stockCheck.isAvailable ? '库存不足' : '支付未验证',
      order: order
    }
  }];
}

// 生成发货单
const shippingOrder = {
  orderId: order.orderId,
  customerInfo: {
    name: order.customerName,
    email: order.customerEmail,
    phone: order.customerPhone,
    address: order.shippingAddress
  },
  items: order.items.map(item => ({
    productId: item.productId,
    productName: item.productName,
    quantity: item.quantity,
    unitPrice: item.unitPrice
  })),
  shippingMethod: order.shippingMethod || 'standard',
  trackingNumber: generateTrackingNumber(),
  estimatedDelivery: calculateDeliveryDate(order.shippingMethod),
  createdAt: new Date().toISOString()
};

function generateTrackingNumber() {
  return 'TRK' + Date.now() + Math.random().toString(36).substr(2, 5).toUpperCase();
}

function calculateDeliveryDate(method) {
  const deliveryDays = {
    'standard': 3,
    'express': 1,
    'overnight': 1
  };
  
  const days = deliveryDays[method] || 3;
  const date = new Date();
  date.setDate(date.getDate() + days);
  return date.toISOString();
}

return [{
  json: {
    canShip: true,
    shippingOrder,
    order: order
  }
}];
```

#### 4.2 调用物流API
```javascript
// Code节点：调用物流API
const shippingOrder = $input.first().json.shippingOrder;

return [{
  json: {
    method: 'POST',
    url: 'https://api.logistics.com/shipments',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer {{ $env.LOGISTICS_API_KEY }}'
    },
    body: JSON.stringify({
      orderId: shippingOrder.orderId,
      customerInfo: shippingOrder.customerInfo,
      items: shippingOrder.items,
      shippingMethod: shippingOrder.shippingMethod,
      trackingNumber: shippingOrder.trackingNumber
    })
  }
}];
```

### 5. 通知发送模块

#### 5.1 邮件通知模板
```javascript
// Code节点：生成邮件内容
const order = $input.first().json.order;
const shippingOrder = $input.first().json.shippingOrder;
const logisticsResponse = $input.first().json;

const emailContent = {
  to: order.customerEmail,
  subject: `订单 ${order.orderId} 已发货`,
  html: `
    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
      <h2 style="color: #333;">订单发货通知</h2>
      <p>尊敬的 ${order.customerName}，</p>
      <p>您的订单 <strong>${order.orderId}</strong> 已成功发货！</p>
      
      <div style="background: #f5f5f5; padding: 15px; margin: 20px 0; border-radius: 5px;">
        <h3>订单详情</h3>
        <p><strong>订单号：</strong>${order.orderId}</p>
        <p><strong>发货时间：</strong>${new Date().toLocaleString('zh-CN')}</p>
        <p><strong>预计送达：</strong>${new Date(shippingOrder.estimatedDelivery).toLocaleDateString('zh-CN')}</p>
        <p><strong>物流单号：</strong>${shippingOrder.trackingNumber}</p>
      </div>
      
      <div style="background: #f5f5f5; padding: 15px; margin: 20px 0; border-radius: 5px;">
        <h3>商品清单</h3>
        ${order.items.map(item => `
          <div style="margin: 10px 0; padding: 10px; background: white; border-radius: 3px;">
            <p><strong>${item.productName}</strong></p>
            <p>数量：${item.quantity} × ¥${item.unitPrice}</p>
          </div>
        `).join('')}
      </div>
      
      <p>感谢您的购买，如有任何问题，请随时联系我们。</p>
      <p>祝您购物愉快！</p>
    </div>
  `
};

return [{
  json: emailContent
}];
```

#### 5.2 短信通知
```javascript
// Code节点：生成短信内容
const order = $input.first().json.order;
const shippingOrder = $input.first().json.shippingOrder;

const smsContent = {
  to: order.customerPhone,
  message: `您的订单${order.orderId}已发货，物流单号：${shippingOrder.trackingNumber}，预计${new Date(shippingOrder.estimatedDelivery).toLocaleDateString('zh-CN')}送达。`
};

return [{
  json: smsContent
}];
```

### 6. 工作流完整配置

#### 6.1 主工作流结构
```
Webhook → 订单验证 → IF节点 → 库存检查 → 支付确认 → IF节点 → 发货处理 → 通知发送
   ↓         ↓         ↓         ↓         ↓         ↓         ↓         ↓
 接收订单   验证数据   验证通过   检查库存   确认支付   支付成功   生成发货单   发送通知
   ↓         ↓         ↓         ↓         ↓         ↓         ↓         ↓
 返回响应   记录日志   继续处理   记录结果   记录结果   继续处理   调用物流   记录完成
```

#### 6.2 错误处理分支
```
IF节点(验证失败) → 错误通知 → 记录错误日志
IF节点(库存不足) → 库存通知 → 记录库存问题
IF节点(支付失败) → 支付通知 → 记录支付问题
```

### 7. 监控与日志

#### 7.1 执行日志记录
```javascript
// Code节点：记录执行日志
const executionData = {
  workflowId: $workflow.id,
  executionId: $execution.id,
  step: $node.name,
  timestamp: new Date().toISOString(),
  input: $input.first().json,
  output: $json,
  status: 'success'
};

// 发送到日志系统
return [{
  json: {
    method: 'POST',
    url: 'https://api.logging.com/logs',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(executionData)
  }
}];
```

#### 7.2 性能监控
```javascript
// Code节点：性能监控
const startTime = $execution.startTime;
const currentTime = new Date();
const executionTime = currentTime - startTime;

const performanceData = {
  workflowId: $workflow.id,
  executionId: $execution.id,
  step: $node.name,
  executionTime: executionTime,
  timestamp: currentTime.toISOString()
};

// 如果执行时间超过阈值，发送告警
if (executionTime > 30000) { // 30秒
  return [{
    json: {
      alert: true,
      message: `工作流执行时间过长: ${executionTime}ms`,
      performanceData
    }
  }];
}

return [{
  json: {
    alert: false,
    performanceData
  }
}];
```

## 测试与部署

### 测试用例

#### 1. 正常订单流程
```json
{
  "orderId": "ORD-2024-001",
  "customerName": "张三",
  "customerEmail": "zhangsan@example.com",
  "customerPhone": "13800138000",
  "shippingAddress": "北京市朝阳区xxx街道xxx号",
  "items": [
    {
      "productId": "PROD-001",
      "productName": "iPhone 15",
      "quantity": 1,
      "unitPrice": 5999
    }
  ],
  "totalAmount": 5999,
  "paymentId": "PAY-2024-001",
  "shippingMethod": "express",
  "createdAt": "2024-01-15T10:00:00Z"
}
```

#### 2. 库存不足场景
```json
{
  "orderId": "ORD-2024-002",
  "customerName": "李四",
  "customerEmail": "lisi@example.com",
  "customerPhone": "13900139000",
  "shippingAddress": "上海市浦东新区xxx路xxx号",
  "items": [
    {
      "productId": "PROD-002",
      "productName": "MacBook Pro",
      "quantity": 5,
      "unitPrice": 12999
    }
  ],
  "totalAmount": 64995,
  "paymentId": "PAY-2024-002",
  "shippingMethod": "standard",
  "createdAt": "2024-01-15T11:00:00Z"
}
```

### 部署配置

#### Docker Compose配置
```yaml
version: '3.8'
services:
  n8n:
    image: n8nio/n8n
    ports:
      - "5678:5678"
    environment:
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=admin
      - N8N_BASIC_AUTH_PASSWORD=secure_password
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=postgres
      - DB_POSTGRESDB_DATABASE=n8n
      - DB_POSTGRESDB_USER=n8n
      - DB_POSTGRESDB_PASSWORD=n8n_password
      - INVENTORY_API_KEY=your_inventory_api_key
      - PAYMENT_API_KEY=your_payment_api_key
      - LOGISTICS_API_KEY=your_logistics_api_key
      - EMAIL_API_KEY=your_email_api_key
      - SMS_API_KEY=your_sms_api_key
    volumes:
      - n8n_data:/home/node/.n8n
    depends_on:
      - postgres

  postgres:
    image: postgres:13
    environment:
      - POSTGRES_DB=n8n
      - POSTGRES_USER=n8n
      - POSTGRES_PASSWORD=n8n_password
    volumes:
      - postgres_data:/var/lib/postgresql/data

volumes:
  n8n_data:
  postgres_data:
```

## 项目总结

### 实现效果
1. **自动化程度**：订单处理全流程自动化，人工干预率降低90%
2. **处理效率**：订单处理时间从平均30分钟缩短到5分钟
3. **错误率**：人工错误率从5%降低到0.1%
4. **客户满意度**：发货通知及时性提升，客户满意度提升15%

### 技术亮点
1. **模块化设计**：各功能模块独立，便于维护和扩展
2. **错误处理**：完善的错误处理和重试机制
3. **监控告警**：实时监控和异常告警
4. **可扩展性**：支持多种支付方式、物流方式扩展

### 后续优化
1. **机器学习**：引入ML模型预测库存需求
2. **智能路由**：根据客户位置智能选择物流方式
3. **实时分析**：实时订单数据分析仪表板
4. **移动端**：开发移动端管理应用 